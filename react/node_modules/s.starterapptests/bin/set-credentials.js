#!/usr/bin/env node

import simpleGit from "simple-git";
import { fileURLToPath } from "url";
import { dirname, join } from "path";
import { exec } from "child_process";
import readline from "readline";

let git;

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const __currentDir = join(__dirname, "..");
const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout,
});

git = simpleGit(__currentDir);

try {
  checkGitCredential();
} catch (ex) {
  console.error("things broke");
}

function checkGitCredential() {
  exec("git config --global user.name", (error, stdout, stderr) => {
    if (error) {
      console.log(`error: ${error.message}`);
      return;
    }
    if (stderr) {
      console.log(`stderr: ${stderr}`);
      return;
    }
    console.log(`Your git name is currently set as ${stdout}`);
    console.log(
      `Please ensure that it is the same name as your Github account.`
    );
    rl.question("Is this correct? Y/N: ", function (answer) {
      if (answer.includes("N") || answer.includes("n")) {
        changeGitCredentials();
      } else {
        console.log("No changes have been made to your git username.");
        rl.close();
      }
    });
  });
}

function changeGitCredentials() {
  console.log(
    "Please enter your github username. No extra quotes, no extra special characters."
  );
  rl.question("Github Username: ", function (inputName) {
    exec(`git config --global user.name "${inputName}"`);
    exec(`git config user.name "${inputName}"`);
    rl.question(
      `Name has been set successfully to ${inputName}. Is this correct? Y/N: `,
      function (answer) {
        if (answer.includes("Y") || answer.includes("y")) {
          checkGitEmailCredentials();
        } else {
          changeGitCredentials();
        }
      }
    );
  });
}

function checkGitEmailCredentials() {
  exec("git config --global user.email", (error, stdout, stderr) => {
    if (error) {
      console.log(`error: ${error.message}`);
      return;
    }
    if (stderr) {
      console.log(`stderr: ${stderr}`);
      return;
    }
    console.log(`Your git email is currently set to ${stdout}`);
    console.log(
      "Please ensure that this is the same as the email used to create your GitHub account."
    );

    rl.question("Is this correct? Y/N: ", function (answer) {
      if (answer.includes("N") || answer.includes("n")) {
        changeGitEmailCredentials();
      } else {
        console.log("No changes have been made to your git email.");
        rl.close();
      }
    });
  });
}

function changeGitEmailCredentials() {
  console.log(
    "Please enter your github email. No extra quotes, no extra special characters."
  );
  rl.question("Github Email: ", function (inputEmail) {
    exec(`git config --global user.email "${inputEmail}"`);
    exec(`git config user.email "${inputEmail}"`);
    rl.question(
      `Email has been set successfully to ${inputEmail}. Is this correct? Y/N: `,
      function (answer) {
        if (answer.includes("Y") || answer.includes("y")) {
          rl.close();
        } else {
          changeGitEmailCredentials();
        }
      }
    );
  });
}
